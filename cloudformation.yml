AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy Laravel + Vue microservices via Docker Compose on a Free-Tier EC2 (ap-southeast-2)
# Free Tier Notes:
# - EC2: 750 hours/month of t2.micro (first 12 months)
# - EBS: 30GB of General Purpose (SSD) storage (first 12 months)
# - Data Transfer: 15GB outbound/month (first 12 months)
# - Security Groups: Always free

Parameters:
  KeyName:
    Description: SSH Key Pair Name for EC2 access (select your key pair)
    Type: AWS::EC2::KeyPair::KeyName

  LatestAmiId:
    Description: Latest Amazon Linux 2 AMI for the current region (SSM parameter)
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2

  InstanceType:
    Description: EC2 Instance Type (t3.micro recommended - free tier eligible with better performance)
    Type: String
    Default: t3.micro
    AllowedValues:
      - t2.micro
      - t3.micro
      - t2.small
      - t3.small
    ConstraintDescription: Must be a valid EC2 instance type

  VolumeSize:
    Description: EBS Volume Size in GB (Free tier includes 30GB, default 20GB leaves room for OS)
    Type: Number
    Default: 20
    MinValue: 8
    MaxValue: 30

Resources:
  ECOMMERCEInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH, HTTP and service ports for the Laravel microservices
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8003
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 1025
          ToPort: 1025
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8025
          ToPort: 8025
          CidrIp: 0.0.0.0/0

  ECOMMERCEInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      ImageId: !Ref LatestAmiId
      SecurityGroupIds:
        - !Ref ECOMMERCEInstanceSecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref VolumeSize
            VolumeType: gp3
            DeleteOnTermination: true
            Encrypted: false
      Tags:
        - Key: Name
          Value: laravel-ecommerce-instance
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          # update
          yum update -y

          # Create swap file (2GB) to help with memory constraints on t3.micro
          # This helps prevent out-of-memory issues when running multiple containers
          dd if=/dev/zero of=/swapfile bs=1M count=2048
          chmod 600 /swapfile
          mkswap /swapfile
          swapon /swapfile
          echo '/swapfile none swap sw 0 0' >> /etc/fstab
          
          # Set swappiness to 10 (default is 60) - less aggressive swapping
          echo 'vm.swappiness=10' >> /etc/sysctl.conf
          sysctl -p

          # install Docker
          amazon-linux-extras install -y docker
          systemctl enable docker
          systemctl start docker
          usermod -aG docker ec2-user

          # install docker-compose (standalone binary)
          curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose || true

          # install git
          yum install -y git

          # give ec2-user permission to use docker without sudo in the session
          newgrp docker <<'NEWGRP'
          echo "docker group updated"
          NEWGRP

          # clone your repo (replace if you use a different branch)
          cd /home/ec2-user
          if [ -d "laravel-ecommerce" ]; then
            cd laravel-ecommerce
            git pull || true
          else
            git clone https://github.com/w33haa2/laravel-ecommerce.git laravel-ecommerce || true
            cd laravel-ecommerce
          fi

          # Get instance public DNS for APP_URL
          INSTANCE_DNS=$(curl -s http://169.254.169.254/latest/meta-data/public-hostname)

          # Create .env files if they don't exist
          if [ ! -f app/.env ]; then
            printf 'APP_NAME="Laravel E-commerce"\nAPP_ENV=production\nAPP_KEY=\nAPP_DEBUG=false\nAPP_URL=http://%s\n\nDB_CONNECTION=mysql\nDB_HOST=mysql\nDB_PORT=3306\nDB_DATABASE=laravel\nDB_USERNAME=sail\nDB_PASSWORD=password\n\nAPI_CATALOG_URL=http://api-catalog:80\nAPI_CHECKOUT_URL=http://api-checkout:80\nAPI_EMAIL_URL=http://api-email:80\n' "$INSTANCE_DNS" > app/.env
          fi

          if [ ! -f api-catalog/.env ]; then
            printf 'APP_NAME="Catalog API"\nAPP_ENV=production\nAPP_KEY=\nAPP_DEBUG=false\nAPP_URL=http://%s:8001\n\nDB_CONNECTION=mysql\nDB_HOST=mysql\nDB_PORT=3306\nDB_DATABASE=catalog_db\nDB_USERNAME=sail\nDB_PASSWORD=password\n' "$INSTANCE_DNS" > api-catalog/.env
          fi

          if [ ! -f api-checkout/.env ]; then
            printf 'APP_NAME="Checkout API"\nAPP_ENV=production\nAPP_KEY=\nAPP_DEBUG=false\nAPP_URL=http://%s:8002\n\nDB_CONNECTION=mysql\nDB_HOST=mysql\nDB_PORT=3306\nDB_DATABASE=checkout_db\nDB_USERNAME=sail\nDB_PASSWORD=password\n\nAPI_EMAIL_URL=http://api-email:80\n' "$INSTANCE_DNS" > api-checkout/.env
          fi

          if [ ! -f api-email/.env ]; then
            printf 'APP_NAME="Email API"\nAPP_ENV=production\nAPP_KEY=\nAPP_DEBUG=false\nAPP_URL=http://%s:8003\n\nDB_CONNECTION=mysql\nDB_HOST=mysql\nDB_PORT=3306\nDB_DATABASE=email_db\nDB_USERNAME=sail\nDB_PASSWORD=password\n' "$INSTANCE_DNS" > api-email/.env
          fi

          # ensure docker-compose.yml exists
          if [ -f docker-compose.yml ]; then
            /usr/local/bin/docker-compose down || true
            /usr/local/bin/docker-compose build --no-cache || true
            /usr/local/bin/docker-compose up -d
            
            # Wait for containers to be ready
            # key:generate and migrations are handled by the container entrypoint
          else
            echo "docker-compose.yml not found in repo root"
          fi

Outputs:
  PublicIP:
    Description: Public IP of EC2 instance
    Value: !GetAtt ECOMMERCEInstance.PublicIp

  InstanceId:
    Description: EC2 Instance ID
    Value: !Ref ECOMMERCEInstance

  AppURL:
    Description: App (frontend) URL
    Value: !Sub "http://${ECOMMERCEInstance.PublicDnsName}"

  CatalogURL:
    Description: API Catalog URL
    Value: !Sub "http://${ECOMMERCEInstance.PublicDnsName}:8001"

  CheckoutURL:
    Description: API Checkout URL
    Value: !Sub "http://${ECOMMERCEInstance.PublicDnsName}:8002"

  EmailURL:
    Description: API Email URL
    Value: !Sub "http://${ECOMMERCEInstance.PublicDnsName}:8003"

  MailpitDashboard:
    Description: Mailpit dashboard
    Value: !Sub "http://${ECOMMERCEInstance.PublicDnsName}:8025"

  FreeTierInfo:
    Description: Free Tier Usage Information
    Value: !Sub "EC2: ~730 hours/month (750 free), EBS: ${VolumeSize}GB (30GB free tier limit), Monitor in AWS Billing Dashboard"
